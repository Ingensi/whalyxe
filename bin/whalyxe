#!/usr/bin/ruby

# Dependencies
require 'yaml'
require 'logger'
require 'erubis'

# Folders constants
PATHS = {
    whalyxe: '/etc/whalyxe',
    lib: '/usr/lib/whalyxe',
    logs: '/etc/whalyxe/logs',
    dhcp: {
        config: '/etc/dhcp/dhcpd.conf',
        bin: '/usr/sbin/dhcpd',
        pid: '/var/run/dhcpd.pid'
    }
}

BINARIES = {
    nginx: '/usr/sbin/nginx',
    tftp: "/usr/sbin/in.tftpd -l -R 4096:32767 -s #{PATHS[:whalyxe]}/tftp",
    dhcp: "#{PATHS[:dhcp][:bin]} -f -cf #{PATHS[:dhcp][:config]} -pf #{PATHS[:dhcp][:pid]}"
}

# Whalyxe constants
WHALYXE = {
    version: '1.0.0',
    config: YAML.load_file("#{PATHS[:whalyxe]}/whalyxe.conf"),
    tftp_root: "#{PATHS[:whalyxe]}/tftp",
    logs: {
        dhcp: File.open("#{PATHS[:logs]}/dhcp.log", 'w'),
        nginx: File.open("#{PATHS[:logs]}/http.log", 'w'),
        tftp: File.open("#{PATHS[:logs]}/tftp.log", 'w')
    }
}

# Logging helper
LOGGER = Logger.new(STDOUT)
LOGGER.level = case WHALYXE[:config]['log_level']
                 when 'debug'
                   Logger::DEBUG
                 when 'info'
                   Logger::INFO
                 else
                   Logger::WARN
               end

# Compiling DHCP configuration file
def configure_dhcp
  LOGGER.info 'Compiling dhcp config file'
  # Generating file from template
  config = Erubis::Eruby.new(File.read "#{PATHS[:lib]}/template/dhcpd.conf.erb").result({dhcp: WHALYXE[:config]['dhcp']})
  # Writing file
  File.write PATHS[:dhcp][:config], config
  LOGGER.debug "Compiled dhcp config file :\n\n#{config}\n"
  LOGGER.info 'Done compiling dhcp config file'
rescue
  LOGGER.fatal 'An error occurred while compiling dhcp config file. Aborting...'
  exit 1
end

# Entry point
def main
  LOGGER.info "Starting up Whalyxe, version #{WHALYXE[:version]} !"
  # Compile dhcp server configuration
  configure_dhcp
  # Start dhcpd server
  LOGGER.info 'Starting up dhcp server'
  Process.spawn BINARIES[:dhcp], out: WHALYXE[:logs][:dhcp], err: WHALYXE[:logs][:dhcp]
  # Start tftp server
  LOGGER.info 'Starting up tftp server'
  Process.spawn BINARIES[:tftp], out: WHALYXE[:logs][:tftp], err: WHALYXE[:logs][:tftp]
  # Start http server
  LOGGER.info 'Starting up http server'
  Process.spawn BINARIES[:nginx], out: WHALYXE[:logs][:nginx], err: WHALYXE[:logs][:nginx]
  # Keeping main process running so the container wont close
  sleep
rescue
  LOGGER.fatal 'Something nasty happened to Whalyxe... this is... bad, time to abort !'
  exit 2
end

main
exit 0